#!/usr/bin/env coffee

optimist = require 'optimist'
defaults = require '../lib/defaults'
path = require 'path'

cwd = process.cwd()

optimist.usage '''
  Usage:
    haw build --config ./package.json --output ./build
    haw serve --port 1234
'''

options = optimist.options({
  c: alias: 'config', description: 'Configuration file'
  r: alias: 'root', description: 'Root from which to look for files'
  p: alias: 'port', description: 'Port on which to run the server'
  o: alias: 'output', description: 'Directory in which to output the site'
  q: alias: 'quiet', description: 'Don\'t show any working info'
  d: alias: 'debug', description: 'Show lots of working info'
  v: alias: 'version', description: 'Print the version number'
  h: alias: 'help', description: 'Print some help'
}).argv

[command, commandArgs...] = options._

command = 'help' if options.help
command = 'version' if options.version

switch command
  when 's', 'serve', 'server'
    [port] = commandArgs
    Server = require '../lib/server'
    server = new Server options
    server.serve port, options

  when 'build', 'builder'
    Builder = require '../lib/builder'
    [output] = commandArgs
    (new Builder config).build output, options

  when 'help'
    optimist.showHelp() # TODO

  when 'version'
    console.log (require path.join __dirname, '..', 'package').version

  else
    optimist.showHelp()
